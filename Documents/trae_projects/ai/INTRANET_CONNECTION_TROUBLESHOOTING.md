# OpenAgents 内网连接故障排除指南

## 当前状态检查

根据我们的检查，您的OpenAgents网络已经**成功启动**，并且**本地连接正常**：

- ✅ OpenAgents网络服务正在运行（端口8700）
- ✅ 本地HTTP访问正常（`curl http://localhost:8700` 返回200 OK）

## 内网连接失败的可能原因

### 1. 内网穿透配置错误

**检查项目**：
- [ ] 内网IP地址是否正确
- [ ] 内网端口是否设置为8700
- [ ] 映射类型是否选择了HTTP
- [ ] 外网地址是否正确分配

**解决方法**：
1. 确认您的本地IP地址：
   ```bash
   ipconfig | findstr IPv4
   ```
   您的本地IP应该是：**192.168.91.179**

2. 在内网穿透软件中重新配置映射：
   - 映射名称：OpenAgents
   - 映射类型：HTTP
   - 内网地址：192.168.91.179
   - 内网端口：8700

### 2. Windows防火墙设置

**检查项目**：
- [ ] Windows防火墙是否允许8700端口的入站连接

**解决方法**：
1. 打开Windows Defender防火墙
2. 点击"高级设置"
3. 点击"入站规则" > "新建规则"
4. 选择"端口" > "TCP" > "特定本地端口：8700"
5. 选择"允许连接"
6. 选择所有网络类型
7. 命名为"OpenAgents HTTP"并完成

### 3. 网络设备限制

**检查项目**：
- [ ] 路由器是否限制了端口转发
- [ ] 路由器是否启用了AP隔离
- [ ] 路由器是否限制了某些网络服务

**解决方法**：
1. 登录路由器管理界面
2. 确认UPnP功能是否启用（如果内网穿透使用UPnP）
3. 检查是否有其他网络限制规则

### 4. 内网穿透服务问题

**检查项目**：
- [ ] 内网穿透服务是否正常运行
- [ ] 映射状态是否为"在线"
- [ ] 内网穿透服务是否有流量限制

**解决方法**：
1. 重启内网穿透服务
2. 检查内网穿透软件的日志
3. 确认网络连接是否稳定

## 验证连接的步骤

### 步骤1：验证本地连接

```bash
curl http://localhost:8700
```

如果返回HTML内容（包含"ProductionNetwork - OpenAgents Agent Network"），说明本地连接正常。

### 步骤2：验证内网IP连接

使用另一台设备在同一局域网内测试：

```bash
curl http://192.168.91.179:8700
```

如果返回相同的HTML内容，说明内网连接正常。

### 步骤3：验证外网连接

使用外网设备测试内网穿透地址：

```bash
curl http://您的外网地址.vicp.fun
```

或者在浏览器中访问该地址。

## 常见错误及解决方案

### 错误1：无法连接到远程服务器

**可能原因**：内网穿透服务未运行或配置错误
**解决方案**：
- 重启内网穿透服务
- 检查映射配置是否正确
- 确认本地网络连接是否稳定

### 错误2：连接被拒绝

**可能原因**：防火墙阻止连接或端口未开放
**解决方案**：
- 检查Windows防火墙设置
- 确认OpenAgents网络正在运行
- 检查端口8700是否被其他程序占用

### 错误3：502 Bad Gateway

**可能原因**：内网穿透服务无法连接到OpenAgents网络
**解决方案**：
- 检查OpenAgents网络是否正常运行
- 确认内网IP和端口配置正确
- 重启OpenAgents网络

## 重新配置指南

如果上述方法都无法解决问题，您可以尝试重新配置整个系统：

1. 停止OpenAgents网络：
   ```bash
   Ctrl+C  # 在运行OpenAgents网络的终端中按下
   ```

2. 重启内网穿透服务

3. 重新启动OpenAgents网络：
   ```bash
   openagents network start ./my_first_network
   ```

4. 重新配置内网穿透映射

5. 验证连接

## 联系支持

如果您在尝试了所有这些步骤后仍然遇到问题，请提供以下信息以便进一步帮助：

1. 内网穿透软件的完整截图
2. 内网穿透软件的日志
3. OpenAgents网络的启动日志
4. 路由器型号和配置

您可以通过 `check_command_status` 命令获取OpenAgents网络的完整日志：

```bash
# 请使用实际的命令ID
check_command_status --command_id=YOUR_COMMAND_ID
```

---

希望这些故障排除步骤能帮助您解决内网连接问题。如果您需要进一步的帮助，请随时咨询！