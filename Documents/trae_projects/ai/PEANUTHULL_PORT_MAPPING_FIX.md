# 花生壳端口映射配置错误修复指南

## 问题分析

从网络日志和连接测试结果分析，发现健康检查失败的原因是：

### 1. 花生壳端口映射错误
日志显示有请求访问：`http://1nz171374pe64.vicp.fun:34675/`
但我们的OpenAgents网络配置的端口是：`8700`

### 2. 连接测试结果
```
警告: TCP connect to (115.236.153.172 : 8700) failed
警告: Ping to 115.236.153.172 failed with status: TimedOut
TcpTestSucceeded        : False
```

这表明花生壳的端口映射配置可能有误，将外部端口映射到了`34675`而不是我们期望的`8700`。

## 解决方案

### 步骤1：检查并修复花生壳端口映射配置

1. **打开花生壳客户端**
   - 找到系统托盘中的花生壳图标
   - 右键点击并选择"显示控制台"

2. **检查端口映射设置**
   - 在花生壳控制台中，找到"端口映射"或"映射管理"部分
   - 查看当前的映射列表，找到与OpenAgents相关的映射

3. **修复映射配置**
   - 确保映射的**内部端口**设置为`8700`
   - 记录映射的**外部端口**（可能是`34675`或其他端口）
   - 确保映射类型为`HTTP`或`TCP`
   - 确保内部主机IP地址正确（应该是您本地机器的IP地址，如`192.168.91.179`）

### 步骤2：更新OpenAgents控制台配置

1. **登录OpenAgents控制台**
   - 打开浏览器，访问OpenAgents平台
   - 进入"发布网络"页面

2. **修复网络配置**
   - **网络主持人**：保持为`1nz171374pe64.vicp.fun`（不要包含斜杠）
   - **网络端口**：输入花生壳映射的**外部端口**（例如`34675`，具体以花生壳控制台显示为准）

### 步骤3：验证修复

1. **重启OpenAgents网络**
   ```bash
   openagents network stop ./my_first_network
   openagents network start ./my_first_network
   ```

2. **测试外部连接**
   使用花生壳的外部端口测试健康检查：
   ```bash
   curl.exe -s http://1nz171374pe64.vicp.fun:34675/api/health
   ```
   （将`34675`替换为您实际的花生壳外部端口）

3. **重新发布网络**
   在OpenAgents控制台中点击"发布"按钮，查看健康检查是否通过

## 替代方案：使用正确的端口映射

如果您希望花生壳使用标准的`8700`端口，可以尝试：

1. 在花生壳控制台中，删除现有的映射
2. 创建一个新的映射：
   - 映射名称：OpenAgents
   - 映射类型：HTTP
   - 内部主机：您的本地IP地址（如`192.168.91.179`）
   - 内部端口：`8700`
   - 外部端口：选择`8700`或让花生壳自动分配
3. 保存配置并等待映射生效（可能需要几分钟）
4. 在OpenAgents控制台中更新网络端口配置

## 常见问题排查

### 问题1：花生壳映射状态显示"离线"
- 确保花生壳客户端保持运行状态
- 检查您的网络连接是否稳定
- 重启花生壳客户端

### 问题2：端口映射配置正确但仍无法访问
- 检查Windows防火墙是否允许端口`8700`的入站连接
- 检查路由器是否限制了端口转发
- 尝试重启路由器和计算机

### 问题3：健康检查仍然失败
- 确保OpenAgents网络正在运行：`openagents network status ./my_first_network`
- 检查花生壳域名是否已正确解析：`nslookup 1nz171374pe64.vicp.fun`
- 尝试使用`ngrok`作为替代的内网穿透方案：
  ```bash
  ngrok http 8700
  ```
  然后在OpenAgents控制台中使用ngrok提供的域名

## 总结

健康检查失败的主要原因是花生壳的端口映射配置错误，将外部端口映射到了`34675`而不是我们配置的`8700`。修复花生壳的端口映射配置并在OpenAgents控制台中更新相应的网络端口后，健康检查应该能够正常通过。

如果您在操作过程中遇到任何问题，请随时联系技术支持或查看花生壳的官方文档。