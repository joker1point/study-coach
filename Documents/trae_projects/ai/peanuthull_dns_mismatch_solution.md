# 花生壳DNS不匹配问题解决方案

## 问题分析

从花生壳配置截图可以看到以下关键问题：

1. **域名指向IP地址**：28.0.0.52（花生壳诊断显示解析成功）
2. **映射IP地址**：28.0.0.50
3. **实际公网IP**：108.181.22.243（通过canyouseeme.org检测到）
4. **错误信息**：`域名指向IP与服务器不一致`

## 问题原因

花生壳的DNS解析配置不正确，域名指向的IP地址（28.0.0.52）与您实际的公网IP地址（108.181.22.243）不匹配。这导致外部请求被发送到错误的IP地址，无法到达您的本地服务器。

## 解决方案

### 步骤1：检查花生壳域名类型

花生壳提供了两种类型的域名：
- **免费动态域名**：使用花生壳自己的DNS服务器，会自动更新IP地址
- **自定义域名**：需要手动配置DNS记录

根据您的配置，您使用的是花生壳提供的动态域名（1nz171374pe64.vicp.fun），这种情况下花生壳应该自动管理IP地址更新。

### 步骤2：重启花生壳客户端

花生壳客户端可能没有正确更新您的公网IP地址。首先尝试重启客户端：

1. 关闭花生壳应用程序
2. 等待30秒
3. 重新打开花生壳应用程序
4. 检查诊断信息，确认`域名指向IP`是否已经更新为正确的公网IP（108.181.22.243）

### 步骤3：手动刷新花生壳映射

如果重启后问题仍然存在，可以尝试手动刷新映射：

1. 在花生壳应用程序中，找到您的自定义映射（Ollama HTTP）
2. 点击右侧的编辑按钮（铅笔图标）
3. 不要修改任何配置，直接点击"保存"或"应用"按钮
4. 再次检查诊断信息，确认IP地址是否更新

### 步骤4：检查花生壳账户状态

确保您的花生壳账户处于正常状态：

1. 检查是否有未支付的费用
2. 确认域名没有过期
3. 检查是否有任何服务限制

### 步骤5：重新创建映射

如果以上步骤都无法解决问题，可以尝试重新创建映射：

1. 删除现有的映射
2. 等待1分钟
3. 创建一个新的映射：
   - 名称：Ollama HTTP
   - 内部主机：192.168.85.179:8700
   - 协议：HTTP
   - 外部端口：自动分配（或指定8700）
4. 保存新映射并检查诊断信息

### 步骤6：验证本地IP地址

确保您的本地IP地址配置正确：

```powershell
# 检查本地IP地址
ipconfig | findstr "IPv4"
```

确认输出中的IP地址与花生壳中配置的内部主机IP（192.168.85.179）一致。

### 步骤7：测试连接

在完成以上步骤后，重新测试外部连接：

```powershell
# 使用新的映射地址测试
curl.exe -s http://1nz171374pe64.vicp.fun/api/health

# 或使用公网IP直接测试
curl.exe -s http://108.181.22.243:8700/api/health
```

## 预期结果

成功解决DNS不匹配问题后：

1. 花生壳诊断信息中应显示：
   - `域名指向IP`：108.181.22.243（与实际公网IP一致）
   - `映射IP地址`：108.181.22.243（与实际公网IP一致）
   - `连接状态`：连接成功

2. 外部测试应返回与本地测试相同的JSON响应：
   ```json
   {"status": "healthy", "timestamp": "...", "components": {...}}
   ```

## 进一步排查

如果问题仍然存在，可能需要考虑以下因素：

1. **ISP限制**：某些ISP可能会阻止端口转发或使用CGNAT（运营商级NAT）
2. **路由器配置**：检查路由器是否启用了DMZ或UPnP功能
3. **防火墙设置**：确保Windows防火墙允许Python应用程序和8700端口的入站连接

请参考完整的《网络连接故障排除指南》获取更详细的排查步骤。